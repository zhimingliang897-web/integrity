<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¯æ—¥çƒ­ç‚¹ | Integrity Lab</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* æ§åˆ¶æ  */
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 20px; }
        .controls input, .controls select {
            background: #14141e; border: 1px solid #2a2a3a; color: #e0e0e0;
            padding: 8px 14px; border-radius: 8px; font-size: 0.9rem; outline: none;
        }
        .controls input:focus, .controls select:focus { border-color: #5b8def; }
        .controls input[type="text"] { flex: 1; min-width: 180px; }
        .controls select { min-width: 160px; cursor: pointer; }
        .date-nav { display: flex; gap: 8px; align-items: center; }
        .date-nav button {
            background: #1e1e30; border: 1px solid #2a2a3a; color: #aaa;
            padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.88rem;
            transition: background 0.15s;
        }
        .date-nav button:hover { background: #2a2a40; color: #fff; }
        .date-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
        .current-date { color: #fff; font-weight: 600; font-size: 0.95rem; min-width: 110px; text-align: center; }

        /* å†å²æ—¥æœŸåˆ—è¡¨ */
        .history-panel { margin-bottom: 20px; }
        .history-toggle {
            background: none; border: 1px solid #2a2a3a; color: #7eb8ff;
            padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.84rem;
            transition: background 0.15s;
        }
        .history-toggle:hover { background: #1e1e30; }
        .history-dates {
            display: none; flex-wrap: wrap; gap: 6px; margin-top: 10px; padding: 12px;
            background: #14141e; border-radius: 8px;
        }
        .history-dates.show { display: flex; }
        .history-dates a {
            padding: 4px 10px; background: #1e1e30; border-radius: 4px;
            color: #aaa; font-size: 0.82rem; text-decoration: none; transition: all 0.12s;
        }
        .history-dates a:hover, .history-dates a.active { background: #5b8def; color: #fff; text-decoration: none; }

        /* æœç´¢ç»“æœé«˜äº® */
        .highlight { background: #5b8def33; padding: 0 2px; border-radius: 2px; }
        .no-results { text-align: center; color: #666; padding: 40px 0; font-size: 0.95rem; }
        .result-count { color: #666; font-size: 0.84rem; margin-bottom: 12px; }
    </style>
</head>
<body>
    <nav>
        <div class="nav-inner">
            <span class="logo">Integrity Lab</span>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="news.html" class="active">AI çƒ­ç‚¹</a>
                <a href="tools.html">å·¥å…·åº“</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>ğŸ“¡ AI æ¯æ—¥çƒ­ç‚¹</h1>
        </div>

        <!-- æ—¥æœŸå¯¼èˆª -->
        <div class="controls">
            <div class="date-nav">
                <button id="btn-prev" title="å‰ä¸€å¤©">â—€</button>
                <span class="current-date" id="current-date">åŠ è½½ä¸­...</span>
                <button id="btn-next" title="åä¸€å¤©">â–¶</button>
            </div>
            <input type="text" id="search-input" placeholder="æœç´¢æ ‡é¢˜ã€æ ‡ç­¾ã€æ¥æº...">
        </div>

        <!-- å†å²æ—¥æœŸ -->
        <div class="history-panel">
            <button class="history-toggle" id="history-toggle">ğŸ“… æŸ¥çœ‹å†å²æ—¥æœŸ</button>
            <div class="history-dates" id="history-dates"></div>
        </div>

        <!-- æ€»ç»“ -->
        <div class="summary" id="summary"></div>

        <!-- æœç´¢ç»“æœè®¡æ•° -->
        <div class="result-count" id="result-count" style="display:none;"></div>

        <!-- æ–°é—»åˆ—è¡¨ -->
        <div id="news-list"></div>
    </div>

    <footer>Integrity Lab Â· ç”± AI æƒ…æŠ¥ Agent è‡ªåŠ¨ç”Ÿæˆ Â· GitHub Actions æ¯æ—¥æ›´æ–°</footer>

<script>
const DATA_BASE = 'data/';
let allDates = [];
let currentIndex = 0;
let currentData = null;

// --- åˆå§‹åŒ– ---
async function init() {
    try {
        const resp = await fetch(DATA_BASE + 'index.json');
        allDates = await resp.json(); // å·²æŒ‰æ—¥æœŸå€’åº
    } catch (e) {
        document.getElementById('news-list').innerHTML =
            '<div class="no-results">æš‚æ— æ•°æ®ï¼Œç­‰å¾…ç¬¬ä¸€æ¬¡ Actions è¿è¡Œåç”Ÿæˆã€‚</div>';
        return;
    }
    if (allDates.length === 0) {
        document.getElementById('news-list').innerHTML =
            '<div class="no-results">æš‚æ— æ•°æ®ã€‚</div>';
        return;
    }
    renderHistoryDates();
    loadDate(0);
}

// --- åŠ è½½æŒ‡å®šæ—¥æœŸ ---
async function loadDate(index) {
    if (index < 0 || index >= allDates.length) return;
    currentIndex = index;
    const date = allDates[index];
    document.getElementById('current-date').textContent = date;
    document.getElementById('btn-prev').disabled = (index >= allDates.length - 1);
    document.getElementById('btn-next').disabled = (index <= 0);

    // é«˜äº®å†å²æ—¥æœŸ
    document.querySelectorAll('.history-dates a').forEach(a => {
        a.classList.toggle('active', a.dataset.date === date);
    });

    try {
        const resp = await fetch(DATA_BASE + date + '.json');
        currentData = await resp.json();
    } catch (e) {
        document.getElementById('news-list').innerHTML =
            '<div class="no-results">è¯¥æ—¥æœŸæ•°æ®åŠ è½½å¤±è´¥ã€‚</div>';
        return;
    }

    document.getElementById('summary').textContent = currentData.summary || '';
    document.getElementById('search-input').value = '';
    document.getElementById('result-count').style.display = 'none';
    renderNews(currentData.news);
}

// --- æ¸²æŸ“æ–°é—»å¡ç‰‡ ---
function renderNews(news, query) {
    const container = document.getElementById('news-list');
    if (!news || news.length === 0) {
        container.innerHTML = '<div class="no-results">è¯¥æ—¥æœŸæ— å†…å®¹ã€‚</div>';
        return;
    }

    container.innerHTML = news.map(item => {
        const badgeMap = { S: 'badge-s', A: 'badge-a', B: 'badge-b' };
        const cls = badgeMap[item.rating] || 'badge-b';
        let title = escapeHtml(item.title);
        let comment = escapeHtml(item.comment);
        let source = escapeHtml(item.source);
        let tagsHtml = (item.tags || []).map(t => {
            let tag = escapeHtml(t);
            if (query) tag = highlightText(tag, query);
            return `<span class="tag">${tag}</span>`;
        }).join('');

        if (query) {
            title = highlightText(title, query);
            comment = highlightText(comment, query);
            source = highlightText(source, query);
        }

        return `
        <div class="card">
            <div class="card-header">
                <span class="badge ${cls}">${item.rating}</span>
                <span class="score">${item.score}åˆ†</span>
                <span class="source">${source}</span>
            </div>
            <h3 class="card-title"><a href="${item.link}" target="_blank">${title}</a></h3>
            <p class="comment">${comment}</p>
            <div class="tags">${tagsHtml}</div>
        </div>`;
    }).join('');
}

// --- æœç´¢ ---
function doSearch(query) {
    if (!query || !currentData) {
        document.getElementById('result-count').style.display = 'none';
        if (currentData) renderNews(currentData.news);
        return;
    }

    const q = query.toLowerCase();
    // æœç´¢æ‰€æœ‰æ—¥æœŸ
    searchAllDates(q);
}

async function searchAllDates(q) {
    let allResults = [];
    for (const date of allDates) {
        try {
            const resp = await fetch(DATA_BASE + date + '.json');
            const data = await resp.json();
            const matched = (data.news || []).filter(item =>
                item.title.toLowerCase().includes(q) ||
                item.comment.toLowerCase().includes(q) ||
                item.source.toLowerCase().includes(q) ||
                (item.tags || []).some(t => t.toLowerCase().includes(q))
            ).map(item => ({ ...item, _date: date }));
            allResults = allResults.concat(matched);
        } catch (e) { /* skip */ }
    }

    const countEl = document.getElementById('result-count');
    if (allResults.length === 0) {
        countEl.style.display = 'block';
        countEl.textContent = `æœªæ‰¾åˆ°ä¸"${q}"ç›¸å…³çš„å†…å®¹`;
        document.getElementById('news-list').innerHTML =
            '<div class="no-results">æ— åŒ¹é…ç»“æœ</div>';
        return;
    }

    countEl.style.display = 'block';
    countEl.textContent = `åœ¨ ${allDates.length} å¤©è®°å½•ä¸­æ‰¾åˆ° ${allResults.length} æ¡åŒ¹é…`;

    // æ¸²æŸ“æœç´¢ç»“æœï¼ˆå¸¦æ—¥æœŸæ ‡è®°ï¼‰
    const container = document.getElementById('news-list');
    container.innerHTML = allResults.map(item => {
        const badgeMap = { S: 'badge-s', A: 'badge-a', B: 'badge-b' };
        const cls = badgeMap[item.rating] || 'badge-b';
        let title = highlightText(escapeHtml(item.title), q);
        let comment = highlightText(escapeHtml(item.comment), q);
        let source = highlightText(escapeHtml(item.source), q);
        let tagsHtml = (item.tags || []).map(t =>
            `<span class="tag">${highlightText(escapeHtml(t), q)}</span>`
        ).join('');

        return `
        <div class="card">
            <div class="card-header">
                <span class="badge ${cls}">${item.rating}</span>
                <span class="score">${item.score}åˆ†</span>
                <span class="source">${source}</span>
                <span class="source">${item._date}</span>
            </div>
            <h3 class="card-title"><a href="${item.link}" target="_blank">${title}</a></h3>
            <p class="comment">${comment}</p>
            <div class="tags">${tagsHtml}</div>
        </div>`;
    }).join('');
}

// --- æ¸²æŸ“å†å²æ—¥æœŸåˆ—è¡¨ ---
function renderHistoryDates() {
    const container = document.getElementById('history-dates');
    container.innerHTML = allDates.map(d =>
        `<a href="#" data-date="${d}" onclick="jumpToDate('${d}');return false;">${d}</a>`
    ).join('');
}

function jumpToDate(date) {
    const idx = allDates.indexOf(date);
    if (idx !== -1) loadDate(idx);
}

// --- å·¥å…·å‡½æ•° ---
function escapeHtml(s) {
    if (!s) return '';
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// --- äº‹ä»¶ç»‘å®š ---
document.getElementById('btn-prev').addEventListener('click', () => loadDate(currentIndex + 1));
document.getElementById('btn-next').addEventListener('click', () => loadDate(currentIndex - 1));

let searchTimer;
document.getElementById('search-input').addEventListener('input', (e) => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => doSearch(e.target.value.trim()), 400);
});

document.getElementById('history-toggle').addEventListener('click', () => {
    document.getElementById('history-dates').classList.toggle('show');
});

// --- å¯åŠ¨ ---
init();
</script>
</body>
</html>
