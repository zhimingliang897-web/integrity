# 更新日志

## v9 — 海报视觉重构 + 标题卡优化

### 两版通用
- **海报重新设计**：从平铺式改为**卡片式排版**
  - 暖沙色背景 `(216,200,172)` + 近白暖色卡片 `(245,240,230)`，圆角 14px
  - 配色简化为三档灰棕 + 暖橙强调色，去掉红棕/深棕等杂色
  - 编号用暖橙 `(190,110,45)` 突出，短语用深炭色 `(38,32,26)` 易读
  - 例句前缀从引号改为 `e.g.`，更轻盈
  - 卡片间距统一 18px，取消分割线和竖条装饰
- **标题卡时长**：3.0s → 1.5s

### 多图版 (`gen_text.py` + `make_video.py`)
- **标题卡升级**：从单字号 50px 居中改为自适应字号（44→28px）
  - 支持 `—` 分割为英文主标题 + 中文副标题双行显示
  - 装饰分割线连接主副标题
- **`_wrap_text` 升级**：从暴力字符拆分改为中英文混合换行（英文按词拆分）
- **`generate_poster` 接口变更**：新增 `title` 和 `episode_num` 参数

## v8 — 双架构方案 + 视频质量优化

### 新增：四宫格方案 (`gen_text_pre.py` + `make_video_pre.py`)
- **AI 分镜脚本**：PROMPT 新增第三部分输出 `Panel 1-4` 画面描述
  - 要求设定主角"视觉锚点"，故事含起因→过程→转折→结尾
  - 每个 Panel 描述必须与对话四段一一对应
- **图片生成**：一次生成一张 1328×1328 四宫格合成图
  - 分镜描述传入 `IMAGE_PROMPT_TEMPLATE` 的 `{p1}{p2}{p3}{p4}` 槽位
  - 有 `IMAGE_PROMPT_FALLBACK` 兜底（未解析到 Panel 时用场景自动编四步）
  - prompt 强调 "4 SEPARATE panels"、"Do NOT draw one panoramic image split by lines"
- **图片切割**：分割线检测 + 均分回退 + 白边剥离
  - `_detect_split_lines_2x2`：逐像素扫描检测中间白线位置和宽度
  - `_strip_solid_border`：逐像素剥离不均匀纯色边框
  - cover 模式：缩放铺满画布 + 居中裁切，彻底消除白边
- **双速视频**：自动生成正常版 + 慢速版（语速 -30%）
- **标题卡**：自适应字号 + `—` 分割双行 + 装饰线
- **视频编码优化**：
  - 中间视频 CRF 0 无损，最终输出 CRF 18 + preset slow
  - `-movflags +faststart` 社交媒体流式优化
  - 字幕 `FontSize=14`，`MarginV=8`

### 多图版改进 (`gen_text.py` + `make_video.py`)
- **文本模型**：`qwen3-max` → `kimi-k2.5`
- **提示词优化**：
  - 对话风格从"雅思5-6分"改为"地道日常口语，native speaker 接地气"
  - 对话长度限制：不超过 12 句台词，每场景 2-3 句
  - 角色名只允许 M1/M2/F1/F2，禁止 Waiter/Angler 等
  - 标题格式统一为 `English Title — 中文标题`
- **图片**：每个 Panel 单独生成一张图（`generate_single_image`）
- **视频**：移除片尾核心表达卡片，改为独立 poster 海报

## v7 — API 自动生成素材
- 新增 `gen_text.py`：一条命令生成文本 + 图片
- 通义千问 API 自动生成对话文本（`qwen3-max-2026-01-23`）
- 通义万相 API 自动生成四宫格插图（`wanx2.1-t2i-turbo`）
- 自动创建项目文件夹和 `input/` 目录
- 已有文件会提示是否覆盖，图片不满意可手动替换

## v6 — 慢速版 + 中文字体修复
- 每次运行自动生成两个视频：正常版 + 慢速版（`_slow.mp4`，语速 -30%）
- Edge TTS `rate` 参数控制语速
- 片尾核心表达卡片间隔从 4 秒增至 6 秒

## v5 — 视频内容增强
- 双语字幕：台词用 `|` 分隔英中文，字幕双行显示
- 开头标题卡：文本第一行识别为标题，黑底白字显示 3 秒
- 片尾核心表达卡片：`===` 之后的内容自动生成卡片附在视频末尾
- 修复中文乱码：卡片和字幕改用微软雅黑字体

## v4 — 多项目文件夹
- `python make_video.py <文件夹名>` 支持多项目独立运行
- 每个项目有自己的 `input/` 和 `output/`
- 输出视频自动以文件夹名命名

## v3 — 自动解析文本
- 代码自动读取 `文本.txt`，不再需要手写 `config.json`
- 支持 `M1/F1` 角色格式 + `---` 场景分隔
- 自动去除括号内舞台提示（如 `(laughs)`）
- 根据场景数自动计算图片网格布局

## v2 — 多角色配音
- 支持男女分声配音（`voices` 字典）
- 声音池自动分配：M1→男声1, F1→女声1, 以此类推
- 字幕移至底部黑色区域，不再遮挡画面

## v1 — 基础版
- 读取 `config.json` + 图片 + 文本
- Edge TTS 生成语音，按语音时长决定画面显示时长
- FFmpeg 切图、拼音频、烧字幕、合成视频
